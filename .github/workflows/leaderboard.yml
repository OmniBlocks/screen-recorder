name: Update Contributor Leaderboard

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-leaderboard:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for accurate stats
      
      - name: Generate Contributor Statistics
        id: stats
        run: |
          echo "Generating contributor statistics..."
          
          # Create temporary files for data
          ALL_TIME_STATS=$(mktemp)
          LAST_30_DAYS_STATS=$(mktemp)
          LAST_YEAR_STATS=$(mktemp)
          AUTHOR_COMMITS_ALL=$(mktemp)
          AUTHOR_COMMITS_30=$(mktemp)
          AUTHOR_COMMITS_YEAR=$(mktemp)
          
          # Get date 30 days ago and 1 year ago
          DATE_30_DAYS_AGO=$(date -d '30 days ago' +%Y-%m-%d 2>/dev/null || date -v-30d +%Y-%m-%d)
          DATE_1_YEAR_AGO=$(date -d '1 year ago' +%Y-%m-%d 2>/dev/null || date -v-1y +%Y-%m-%d)
          
          # Function to calculate stats using git diff for accurate counts
          calculate_stats() {
            local commits_file=$1
            local output_file=$2
            
            # Get unique authors and their commit counts
            cat "$commits_file" | awk -F'|' '{print $1}' | sort | uniq -c | sort -rn | while read count author; do
              author=$(echo "$author" | xargs) # trim whitespace
              if [ -z "$author" ]; then continue; fi
              
              echo "Processing $author..." >&2
              
              # Get all commit SHAs for this author from the commits file
              shas=$(grep "^${author}|" "$commits_file" | awk -F'|' '{print $2}')
              
              additions=0
              deletions=0
              
              # For each commit, use git show to get accurate diff stats
              for sha in $shas; do
                # Use git show with --numstat and handle binary files better
                # First try with --numstat, then fallback to --shortstat for merge commits
                stats=$(git show --numstat --format="" "$sha" 2>/dev/null | awk '
                  BEGIN { add=0; del=0 }
                  # Handle regular files (numeric values)
                  $1 != "-" && $2 != "-" && $1 ~ /^[0-9]+$/ && $2 ~ /^[0-9]+$/ { add+=$1; del+=$2 }
                  # Handle binary files (marked with -)
                  $1 == "-" && $2 == "-" { add+=1; del+=1 }
                  END { print add" "del }
                ')
                
                # If numstat didn't work (e.g., merge commit), try shortstat
                if [ -z "$stats" ] || [ "$stats" = "0 0" ]; then
                  shortstat=$(git show --shortstat --format="" "$sha" 2>/dev/null | grep -o '[0-9]\+ insertion\|[0-9]\+ deletion' | awk '
                    /insertion/ { add+=$1 }
                    /deletion/ { del+=$1 }
                    END { print (add?add:0)" "(del?del:0) }
                  ')
                  if [ -n "$shortstat" ] && [ "$shortstat" != "0 0" ]; then
                    stats="$shortstat"
                  fi
                fi
                
                # If still no stats, try diff-tree for merge commits
                if [ -z "$stats" ] || [ "$stats" = "0 0" ]; then
                  difftree=$(git diff-tree --numstat "$sha" 2>/dev/null | awk '
                    BEGIN { add=0; del=0 }
                    $1 != "-" && $2 != "-" && $1 ~ /^[0-9]+$/ && $2 ~ /^[0-9]+$/ { add+=$1; del+=$2 }
                    $1 == "-" && $2 == "-" { add+=1; del+=1 }
                    END { print add" "del }
                  ')
                  if [ -n "$difftree" ] && [ "$difftree" != "0 0" ]; then
                    stats="$difftree"
                  fi
                fi
                
                if [ -n "$stats" ] && [ "$stats" != "0 0" ]; then
                  add=$(echo "$stats" | awk '{print $1}')
                  del=$(echo "$stats" | awk '{print $2}')
                  additions=$((additions + add))
                  deletions=$((deletions + del))
                fi
              done
              
              total_changes=$((additions + deletions))
              echo "$count|$author|$additions|$deletions|$total_changes"
            done > "$output_file"
          }
          
          # Get all commits with author and SHA (all time)
          git log --format='%aN|%H' > "$AUTHOR_COMMITS_ALL"
          
          # Get commits from last 30 days
          git log --since="$DATE_30_DAYS_AGO" --format='%aN|%H' > "$AUTHOR_COMMITS_30"
          
          # Get commits from last year
          git log --since="$DATE_1_YEAR_AGO" --format='%aN|%H' > "$AUTHOR_COMMITS_YEAR"
          
          # Calculate stats for each time period
          echo "Calculating all-time statistics..." >&2
          calculate_stats "$AUTHOR_COMMITS_ALL" "$ALL_TIME_STATS"
          
          echo "Calculating last 30 days statistics..." >&2
          calculate_stats "$AUTHOR_COMMITS_30" "$LAST_30_DAYS_STATS"
          
          echo "Calculating last year statistics..." >&2
          calculate_stats "$AUTHOR_COMMITS_YEAR" "$LAST_YEAR_STATS"
          
          # Store file paths
          echo "all_time_stats=$ALL_TIME_STATS" >> $GITHUB_OUTPUT
          echo "last_30_days_stats=$LAST_30_DAYS_STATS" >> $GITHUB_OUTPUT
          echo "last_year_stats=$LAST_YEAR_STATS" >> $GITHUB_OUTPUT
          
          echo "Statistics generation complete!" >&2
      
      - name: Format Leaderboard
        id: format
        run: |
          ALL_TIME_STATS="${{ steps.stats.outputs.all_time_stats }}"
          LAST_30_DAYS_STATS="${{ steps.stats.outputs.last_30_days_stats }}"
          LAST_YEAR_STATS="${{ steps.stats.outputs.last_year_stats }}"
          
          # Generate markdown content
          cat > leaderboard.md << 'EOF'
          # ðŸ† Contributor Leaderboard
          
          **Last Updated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ---
          
          ## ðŸ“Š All-Time Statistics
          
          | Rank | Contributor | Commits | Additions âž• | Deletions âž– | Total Changes |
          |------|-------------|---------|--------------|--------------|---------------|
          EOF
          
          # Add all-time stats
          rank=1
          while IFS='|' read -r commits author additions deletions total; do
            if [ -n "$author" ]; then
              # Add medal emojis for top 3
              case $rank in
                1) rank_display="ðŸ¥‡ 1" ;;
                2) rank_display="ðŸ¥ˆ 2" ;;
                3) rank_display="ðŸ¥‰ 3" ;;
                *) rank_display="$rank" ;;
              esac
              printf "| %s | %s | %s | %s | %s | %s |\n" "$rank_display" "$author" "$commits" "$additions" "$deletions" "$total" >> leaderboard.md
              rank=$((rank + 1))
              if [ "$rank" -gt 20 ]; then break; fi
            fi
          done < "$ALL_TIME_STATS"
          
          # Add last year section
          cat >> leaderboard.md << 'EOF'
          
          ---
          
          ## ðŸ“… Last Year Statistics
          
          | Rank | Contributor | Commits | Additions âž• | Deletions âž– | Total Changes |
          |------|-------------|---------|--------------|--------------|---------------|
          EOF
          
          rank=1
          while IFS='|' read -r commits author additions deletions total; do
            if [ -n "$author" ]; then
              # Add medal emojis for top 3
              case $rank in
                1) rank_display="ðŸ¥‡ 1" ;;
                2) rank_display="ðŸ¥ˆ 2" ;;
                3) rank_display="ðŸ¥‰ 3" ;;
                *) rank_display="$rank" ;;
              esac
              printf "| %s | %s | %s | %s | %s | %s |\n" "$rank_display" "$author" "$commits" "$additions" "$deletions" "$total" >> leaderboard.md
              rank=$((rank + 1))
              if [ "$rank" -gt 15 ]; then break; fi
            fi
          done < "$LAST_YEAR_STATS"
          
          # Add last 30 days section
          cat >> leaderboard.md << 'EOF'
          
          ---
          
          ## ðŸ”¥ Last 30 Days Statistics
          
          | Rank | Contributor | Commits | Additions âž• | Deletions âž– | Total Changes |
          |------|-------------|---------|--------------|--------------|---------------|
          EOF
          
          rank=1
          while IFS='|' read -r commits author additions deletions total; do
            if [ -n "$author" ]; then
              # Add medal emojis for top 3
              case $rank in
                1) rank_display="ðŸ¥‡ 1" ;;
                2) rank_display="ðŸ¥ˆ 2" ;;
                3) rank_display="ðŸ¥‰ 3" ;;
                *) rank_display="$rank" ;;
              esac
              printf "| %s | %s | %s | %s | %s | %s |\n" "$rank_display" "$author" "$commits" "$additions" "$deletions" "$total" >> leaderboard.md
              rank=$((rank + 1))
              if [ "$rank" -gt 10 ]; then break; fi
            fi
          done < "$LAST_30_DAYS_STATS"
          
          # Add footer
          cat >> leaderboard.md << 'EOF'
          
          ---
          
          ## ðŸ“ˆ Repository Summary
          
          EOF
          
          # Add repository summary using git show for accurate counts
          total_commits=$(git rev-list --count HEAD)
          total_contributors=$(git log --format='%aN' | sort -u | wc -l)
          
          # Calculate total additions/deletions accurately
          echo "Calculating repository totals..."
          total_stats=$(git log --format='%H' | while read sha; do
            git show --numstat --format="" "$sha" 2>/dev/null | awk '
              $1 != "-" && $2 != "-" { add+=$1; del+=$2 }
              END { print add" "del }
            '
          done | awk '{add+=$1; del+=$2} END {print add" "del}')
          
          total_additions=$(echo "$total_stats" | awk '{print $1}')
          total_deletions=$(echo "$total_stats" | awk '{print $2}')
          
          cat >> leaderboard.md << EOF
          - **Total Commits:** $total_commits
          - **Total Contributors:** $total_contributors
          - **Total Additions:** $total_additions âž•
          - **Total Deletions:** $total_deletions âž–
          - **Net Changes:** $((total_additions - total_deletions))
          
          ---
          
          *This leaderboard is automatically updated daily by [GitHub Actions](https://github.com/${{ github.repository }}/actions/workflows/leaderboard.yml)*
          EOF
          
          # Evaluate the date command properly
          sed -i "s/\$(date -u.*)/$(date -u +"%Y-%m-%d %H:%M:%S UTC")/" leaderboard.md
          
          # Output the content
          echo "LEADERBOARD_CONTENT<<EOFMARKER" >> $GITHUB_OUTPUT
          cat leaderboard.md >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT
      
      - name: Update Issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Update issue #275 with the leaderboard
          gh issue edit 275 \
            --body "${{ steps.format.outputs.LEADERBOARD_CONTENT }}" \
            --repo ${{ github.repository }}
          
          echo "âœ… Leaderboard updated successfully!"
      
      - name: Comment on Success
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment 275 \
            --body "ðŸ¤– Leaderboard updated automatically on $(date -u +"%Y-%m-%d %H:%M:%S UTC")" \
            --repo ${{ github.repository }}
